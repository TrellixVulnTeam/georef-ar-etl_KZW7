{% extends "base.html" %}

{% block banner %}
<div id="banner" class="container-fluid blue-gradient">
    <div class="restricted-max-width">
        <div class="banner-content">
            <div>
                <h1 style="visibility: hidden">Georef</h1>
                <form action="{% url 'normalize' %}" method="post">
                    {% csrf_token %}
                    <div class="col-xs-12 col-sm-12 col-lg-12">
                        <input id="searchbox" name="address" class="form-control search-box"
                            value="{{ request.POST.address|default:"" }}" placeholder="Direcci칩n (ejemplo: Diagonal Norte 788)"
                            autofocus="" type="text" value="" maxlength="255" autocomplete="off" spellcheck="false">
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-6">
                        <select id="state-select" name="state" class="form-control">
                            <option value="" disabled selected>Provincia</option>
                            {% for state in states.provincias|dictsort:"nombre" %}
                                <option value="{{ state.nombre }}">{{ state.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-12 col-sm-6 col-lg-6">
                        <select id="locality-select" name="lacality" class="form-control" disabled>
                            <option value="" disabled selected>Localidad</option>
                            {% for locality in localities.localidades|dictsort:"nombre" %}
                                <option value="{{ locality.nombre }}" data-state="{{ locality.provincia.nombre }}" hidden>
                                    {{ locality.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-xs-12 col-sm-12 col-lg-12">
                        <button id="btn-buscar" type="submit" class="btn btn-primary" style="margin-top:25px">Normalizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="pane-content">
    {% if results %}
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-lg-12">
            <div class="results">
                {% for address in results.direcciones %}
                    <div class="result">
                        <a href="/">
                            <div><span>{{ address.nomenclatura }}</span></div>
                        </a>
                        <div class="details" hidden>
                            <span><strong>Nomenclatura:</strong> {{ address.nomenclatura }}</span><br>
                            <span><strong>Numeraci칩n: </strong> {{ address.altura|default:'No hay datos' }}</span>
                            <span><strong>Tipo de camino:</strong> {{ address.tipo }}</span>
                            <span><strong>Nombre completo:</strong> {{ address.nombre }}</span><br>
                            <span><strong>Localidad:</strong> {{ address.localidad }}</span>
                            <span><strong>Provincia:</strong> {{ address.provincia }}</span><br>
                            {% if address.ubicacion %}
                            <span><strong>Coordenadas geogr치ficas:</strong> {{ address.ubicacion.lat }}, {{ address.ubicacion.lon }}</span><br>
                            {% endif %}
                            <span><strong>Observaciones:</strong> fuente {{ address.observaciones.fuente }}. {{ address.observaciones.info }}</span><br>
                        </div>
                    </div>
                {% empty %}
                    <p style="text-align:center">No hay resultados para mostrar...</p>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    NProgress.configure({ showSpinner: false });
    
    $("#btn-buscar").click(function(e) {
        e.preventDefault();
        if ($("#searchbox").val() === "") {
            alert("Ingresar una direcci칩n para normalizar.");
        }
        else {
            NProgress.start();
            $("form").submit();
        }
    })

    $(".result a").click(function(e){
        e.preventDefault();
        $(this).siblings(".details").toggle("fast");
    });

    $("#state-select").change(function (e) {
        var state = e.target.value;
        $("#locality-select option").hide();
        $("#locality-select option[data-state='" + state + "']").show();
        $("#locality-select").val($("#locality-select option:first").val());
        $("#locality-select").removeAttr("disabled");
    });
</script>
{% endblock %}
